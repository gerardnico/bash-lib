# This script should not be called directly. It is called by direnv
# In your IDE, you can associate the shell language to the extension .envrc.jinja2 for full bash support

# Strict Bash
set -TCEeuo pipefail

echo ""

###################
# Project Env
# Project Environment are common project variables used in script
###################
# Project Root
export ORGANISATION_NAME="gerardnico"
# Name used in env
export ORGANISATION_ENV_NAME="GERARDNICO"
# Name used in path
export ORGANISATION_PATH_NAME="gerardnico"
# Name of the project use as identifier with the organization name
export PROJECT_NAME="bash-lib"
# Used by script to get the root
export PROJECT_ROOT="$PWD"
# ProjectId
export PROJECT_ID="$ORGANISATION_NAME/$PROJECT_NAME"
# The package manager
export PACKAGE_MANAGER="none"

# Common function
source "$PROJECT_ROOT/.envrc.devf.sh"

# Feedback
echo "Project:"
export COL_PROP_LENGTH=17
devf_print_props "Project Root" "${PROJECT_ROOT}"
devf_print_props "Organisation Name" "${ORGANISATION_NAME}"
devf_print_props "Package Manager" "${PACKAGE_MANAGER}"

#################
# DEVF
# Bin script installation
# The installation is done by cloning the repo to a well-known location.
#################
echo ""
echo "Devfiles: "
export DEVF_PREFIX="DEVF"
DEVF_DIR_VAR_NAME="${DEVF_PREFIX}_${ORGANISATION_ENV_NAME}_DIR"
export DEVF_DIR
DEVF_DIR="${!DEVF_DIR_VAR_NAME:-}"
if [ "$DEVF_DIR" != "" ]; then
  devf_print_props "Repo Directory" "$DEVF_DIR (from var $DEVF_DIR_VAR_NAME)"
else
  DEVF_DIR=$(realpath "$PWD/../devfiles")
  devf_print_props "Repo Directory" "$DEVF_DIR (default)"
fi
if [ ! -d "$DEVF_DIR" ]; then

  devf_echo_yellow "DEVF_DIR ($DEVF_DIR) does not exist."
  DEVF_REPO_URI_VAR_NAME="${DEVF_PREFIX}_${ORGANISATION_ENV_NAME}_URI"
  DEVF_REPO_URI="${!DEVF_REPO_URI_VAR_NAME:-https://github.com/combostrap/devfiles}"
  devf_echo_yellow "Clone $DEVF_REPO_URI to $DEVF_DIR? Y(Yes-Default)/N(No)"
  read -r CLONE
  if [ "$CLONE" == "" ] || [ "$CLONE" == "Y" ]; then
    git clone "$DEVF_REPO_URI" "$DEVF_DIR"
    devf_echo_yellow "Repo Manager repo cloned"
  fi
fi

############################
# Pre-commit setup
# Install pre-commit hooks
############################
if command -v pre-commit &>/dev/null; then

  echo ""
  echo "Pre-commit:"
  export COL_PROP_LENGTH=17
  if [ ! -f "$PROJECT_ROOT/.git/hooks/pre-commit" ]; then
    pre-commit install
    devf_print_props "Pre-commit hooks" "installed"
  else
    devf_print_props "Pre-commit hooks" "enabled"
  fi
  if [ ! -f "$PROJECT_ROOT/.git/hooks/commit-msg" ]; then
    pre-commit install --hook-type commit-msg
    devf_print_props "Commit-msg hooks" "installed"
  else
    devf_print_props "Commit-msg hooks" "enabled"
  fi
  if [ ! -f "$PROJECT_ROOT/.git/hooks/post-commit" ]; then
    pre-commit install --hook-type post-commit
    devf_print_props "Post-commit hooks" "installed"
  else
    devf_print_props "Post-commit hooks" "enabled"
  fi
else
  echo "⚠️ pre-commit not found. Install with: pip install pre-commit"
  exit 1
fi

# In case, the repo was not installed
echo ""
echo "Devfiles Scripts:"
if [ -d "$DEVF_DIR" ]; then

  #################
  # Bin
  #################
  DEV_SCRIPT_PATH="$DEVF_DIR/dev-scripts"
  PACKAGE_MANAGER_PATH="$DEV_SCRIPT_PATH/package-manager/$PACKAGE_MANAGER"
  export PATH="$PACKAGE_MANAGER_PATH:$PATH" # script path first as it has a higher priority
  devf_print_props "Package Manager Scripts Path" "$PACKAGE_MANAGER_PATH"
  GIT_HOOKS="$DEV_SCRIPT_PATH/git-hooks"
  export PATH="$GIT_HOOKS:$PATH" # script path first as it has a higher priority
  devf_print_props "Git Hooks Path" "$GIT_HOOKS"
  SETUP_PATH="$DEV_SCRIPT_PATH/setup"
  export PATH="$SETUP_PATH:$PATH" # script path first as it has a higher priority
  devf_print_props "Setup Scripts Path" "$SETUP_PATH"
  WRAPPERS_PATH="$DEV_SCRIPT_PATH/wrappers"
  export PATH="$WRAPPERS_PATH:$PATH" # script path first as it has a higher priority
  devf_print_props "Wrapper Scripts Path" "$WRAPPERS_PATH"

  echo ""
  echo "Git: "
  source "$SETUP_PATH"/git-config.sh

  ############################
  # Maven Setup
  # We need the sdkman setup script
  ############################
  if [ "$PACKAGE_MANAGER" == "maven" ]; then
    echo ""
    echo "Maven: "
    SDKMAN_MAVEN_VERSION=$(grep -oP 'apache-maven/\K[0-9]+\.[0-9]+\.[0-9]+' .mvn/wrapper/maven-wrapper.properties)
    echo "   Version: $SDKMAN_MAVEN_VERSION"

    # mvn setup
    if ! command -v mvn &>/dev/null; then
      echo "Maven mvn command not found in the path. Installing it with sdkman"
      if [[ $(type -t sdk) == "" ]]; then
        # Sdk man init
        source "$DEV_SCRIPT_PATH/setup/sdkman.sh"
      fi
      if ! sdk home maven "${SDKMAN_MAVEN_VERSION}" >/dev/null; then
        devf_echo_yellow "Maven installation with sdkman"
        sdk install maven "${SDKMAN_MAVEN_VERSION}"
      fi
      # Putting maven in the path
      sdk use maven "${SDKMAN_MAVEN_VERSION}"
    fi
    # mvnw setup
    # Does maven wrapper is installed ?
    if [ ! -f "$PROJECT_ROOT/mvnw" ]; then
      devf_echo_yellow "mvn wrapper not found, installing it"
      mvn wrapper:wrapper
    fi
  fi
else
  devf_echo_yellow "WARNING: devfiles repo not installed: git, maven and common script not configured"
fi

##############################
# Load sub envrc project script
##############################
ENVRCD="$PROJECT_ROOT/.envrc.d"
echo ""
echo "Envrc.d scripts: "
if [ -d "$ENVRCD" ]; then
  # All file loaded in a directory should have a sh extension
  # This is how /etc/profile also work
  count=0
  export COL_PROP_LENGTH=1
  for file in "$ENVRCD"/*.sh; do
    count=$((count + 1))
    # shellcheck disable=SC1090
    if [ -r "$file" ]; then
      source "$file"
      devf_print_props "$count" "$(realpath --relative-to="$ENVRCD" "$file")"
    fi
  done
  unset file
else
  echo "   Not found"
fi

echo ""
echo "Env: "
export COL_PROP_LENGTH=17
devf_print_props "PROJECT_ROOT" "$PROJECT_ROOT"
devf_print_props "ORGANISATION_NAME" "$ORGANISATION_NAME"
devf_print_props "DEVF_DIR" "$DEVF_DIR"

# Last EOL before direnv output
echo ""
